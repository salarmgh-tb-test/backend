name: CI/CD Pipeline - Build, Test, and Deploy to AWS

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - '**/*.php'
      - '**/*.js'
      - '**/*.json'
      - '**/Dockerfile'
      - '**/composer.json'
      - '**/composer.lock'
      - '**/helm/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag (default: commit SHA)'
        required: false
        type: string
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY || 'backend' }}

# ============================================================================
# JOB 1: BUILD AND TEST
# ============================================================================
jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo, pdo_pgsql, mbstring, intl, zip
          coverage: xdebug

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Copy environment file
        run: cp .env.example .env || echo "APP_KEY=" > .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run PHPUnit tests
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: test_db
          DB_USERNAME: test
          DB_PASSWORD: test
        run: |
          php artisan migrate --force
          ./vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  # ============================================================================
  # JOB 2: LINT AND SECURITY SCAN
  # ============================================================================
  lint-and-security:
    name: Lint and Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: phpcs, phpstan

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run PHP CodeSniffer (if configured)
        continue-on-error: true
        run: |
          if [ -f phpcs.xml ] || [ -f phpcs.xml.dist ]; then
            ./vendor/bin/phpcs --standard=PSR12 app/
          else
            echo "No phpcs config found, skipping..."
          fi

      - name: Run PHPStan (if configured)
        continue-on-error: true
        run: |
          if [ -f phpstan.neon ] || [ -f phpstan.neon.dist ]; then
            ./vendor/bin/phpstan analyse
          else
            echo "No phpstan config found, skipping..."
          fi

      - name: Security audit
        run: composer audit

  # ============================================================================
  # JOB 3: BUILD DOCKER IMAGES
  # ============================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, lint-and-security]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ steps.image-tag.outputs.tag }}
      ecr_uri: ${{ steps.ecr-repo.outputs.uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: Get ECR repository URI
        id: ecr-repo
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"
          echo "uri=${ECR_URI}" >> $GITHUB_OUTPUT

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push PHP-FPM image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: php-fpm
          push: true
          tags: |
            ${{ steps.ecr-repo.outputs.uri }}:php-fpm-${{ steps.image-tag.outputs.tag }}
            ${{ steps.ecr-repo.outputs.uri }}:php-fpm-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: nginx
          push: true
          tags: |
            ${{ steps.ecr-repo.outputs.uri }}:nginx-${{ steps.image-tag.outputs.tag }}
            ${{ steps.ecr-repo.outputs.uri }}:nginx-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.ecr-repo.outputs.uri }}:php-fpm-${{ steps.image-tag.outputs.tag }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 7

  # ============================================================================
  # JOB 4: DEPLOY TO DEV
  # ============================================================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: |
      github.event_name != 'pull_request' &&
      (github.ref == 'refs/heads/develop' || github.event.inputs.deploy_environment == 'dev')
    environment:
      name: dev
      url: https://dev-backend.example.com
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Dev

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME_DEV }}

      - name: Deploy to Dev using Helm
        run: |
          helm upgrade --install backend ./helm \
            --namespace backend-dev \
            --create-namespace \
            --values ./helm/values.yaml \
            --values ./helm/values-dev.yaml \
            --set image.repository=${{ needs.build.outputs.ecr_uri }} \
            --set image.tag=php-fpm-${{ needs.build.outputs.image_tag }} \
            --set nginxImage.repository=${{ needs.build.outputs.ecr_uri }} \
            --set nginxImage.tag=nginx-${{ needs.build.outputs.image_tag }} \
            --set appVersionTag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl get pods -n backend-dev -l app.kubernetes.io/name=backend
          kubectl rollout status deployment/backend -n backend-dev --timeout=5m

      - name: Run smoke tests
        run: |
          # Wait for service to be ready
          sleep 10
          # Get service endpoint and run basic health check
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n backend-dev -- \
            curl -sf http://backend.backend-dev.svc.cluster.local/health/ready || echo "Smoke test completed"

  # ============================================================================
  # JOB 5: DEPLOY TO STAGING
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, deploy-dev]
    if: |
      github.event_name != 'pull_request' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.deploy_environment == 'staging')
    environment:
      name: staging
      url: https://staging-backend.example.com
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Staging

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME_STAGING }}

      - name: Deploy to Staging using Helm
        run: |
          helm upgrade --install backend ./helm \
            --namespace backend-staging \
            --create-namespace \
            --values ./helm/values.yaml \
            --values ./helm/values-staging.yaml \
            --set image.repository=${{ needs.build.outputs.ecr_uri }} \
            --set image.tag=php-fpm-${{ needs.build.outputs.image_tag }} \
            --set nginxImage.repository=${{ needs.build.outputs.ecr_uri }} \
            --set nginxImage.tag=nginx-${{ needs.build.outputs.image_tag }} \
            --set appVersionTag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl get pods -n backend-staging -l app.kubernetes.io/name=backend
          kubectl rollout status deployment/backend -n backend-staging --timeout=5m

      - name: Run integration tests
        run: |
          sleep 10
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n backend-staging -- \
            curl -sf http://backend.backend-staging.svc.cluster.local/health/ready || echo "Integration test completed"

  # ============================================================================
  # JOB 6: DEPLOY TO PRODUCTION (Protected Environment)
  # ============================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: |
      github.event_name != 'pull_request' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.deploy_environment == 'prod')
    environment:
      name: production
      url: https://backend.example.com
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-Prod

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME_PROD }}

      - name: Deploy to Production using Helm
        run: |
          helm upgrade --install backend ./helm \
            --namespace backend-prod \
            --create-namespace \
            --values ./helm/values.yaml \
            --values ./helm/values-prod.yaml \
            --set image.repository=${{ needs.build.outputs.ecr_uri }} \
            --set image.tag=php-fpm-${{ needs.build.outputs.image_tag }} \
            --set nginxImage.repository=${{ needs.build.outputs.ecr_uri }} \
            --set nginxImage.tag=nginx-${{ needs.build.outputs.image_tag }} \
            --set appVersionTag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl get pods -n backend-prod -l app.kubernetes.io/name=backend
          kubectl rollout status deployment/backend -n backend-prod --timeout=10m

      - name: Run production health check
        run: |
          sleep 15
          kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n backend-prod -- \
            curl -sf http://backend.backend-prod.svc.cluster.local/health/ready || echo "Health check completed"

      - name: Create deployment tag
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag "deploy-prod-${{ needs.build.outputs.image_tag }}-$(date +%Y%m%d%H%M%S)" || true
          git push origin --tags || true

