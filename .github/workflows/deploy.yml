name: Build and Deploy to EKS

on:
  push:
    tags:
      - "v*-alpha*"
      - "v*-rc*"
      - "v*"
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag (default: commit SHA)'
        required: false
        type: string

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY || 'backend' }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  HELM_NAMESPACE: ${{ secrets.HELM_NAMESPACE || 'tradebytes' }}

jobs:
  build-and-deploy:
    name: Build Docker Images and Deploy to EKS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Deploy

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi
          echo "Image tag: $(cat $GITHUB_OUTPUT | grep tag= | cut -d'=' -f2)"

      - name: Get ECR repository URI
        id: ecr-repo
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}"
          echo "uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "ECR Repository URI: ${ECR_URI}"

      - name: Ensure ECR repository exists
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \
          aws ecr create-repository \
            --repository-name ${ECR_REPOSITORY} \
            --region ${AWS_REGION} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      - name: Build PHP-FPM Docker image
        run: |
          docker build \
            --target php-fpm \
            --tag ${{ steps.ecr-repo.outputs.uri }}:php-fpm-${{ steps.image-tag.outputs.tag }} \
            --tag ${{ steps.ecr-repo.outputs.uri }}:php-fpm-latest \
            --file Dockerfile .

      - name: Build Nginx Docker image
        run: |
          docker build \
            --target nginx \
            --tag ${{ steps.ecr-repo.outputs.uri }}:nginx-${{ steps.image-tag.outputs.tag }} \
            --tag ${{ steps.ecr-repo.outputs.uri }}:nginx-latest \
            --file Dockerfile .

      - name: Push PHP-FPM image to ECR
        run: |
          docker push ${{ steps.ecr-repo.outputs.uri }}:php-fpm-${{ steps.image-tag.outputs.tag }}
          docker push ${{ steps.ecr-repo.outputs.uri }}:php-fpm-latest

      - name: Push Nginx image to ECR
        run: |
          docker push ${{ steps.ecr-repo.outputs.uri }}:nginx-${{ steps.image-tag.outputs.tag }}
          docker push ${{ steps.ecr-repo.outputs.uri }}:nginx-latest

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl for EKS
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          EKS_CLUSTER_NAME: ${{ env.EKS_CLUSTER_NAME }}
        run: |
          aws eks update-kubeconfig \
            --region ${AWS_REGION} \
            --name ${EKS_CLUSTER_NAME}

      - name: Verify kubectl connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy to EKS using Helm
        env:
          HELM_NAMESPACE: ${{ env.HELM_NAMESPACE }}
        run: |
          helm upgrade --install backend ./helm \
            --namespace ${HELM_NAMESPACE} \
            --create-namespace \
            --set image.repository=${{ steps.ecr-repo.outputs.uri }} \
            --set image.tag=php-fpm-${{ steps.image-tag.outputs.tag }} \
            --set nginxImage.repository=${{ steps.ecr-repo.outputs.uri }} \
            --set nginxImage.tag=nginx-${{ steps.image-tag.outputs.tag }} \
            --set appVersionTag=${{ steps.image-tag.outputs.tag }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        env:
          HELM_NAMESPACE: ${{ env.HELM_NAMESPACE }}
        run: |
          kubectl get pods -n ${HELM_NAMESPACE} -l app.kubernetes.io/name=backend
          kubectl get svc -n ${HELM_NAMESPACE} -l app.kubernetes.io/name=backend
          kubectl rollout status deployment/backend -n ${HELM_NAMESPACE} --timeout=5m

